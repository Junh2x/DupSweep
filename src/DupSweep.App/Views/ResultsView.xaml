<UserControl x:Class="DupSweep.App.Views.ResultsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:DupSweep.App.ViewModels"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance viewmodels:ResultsViewModel}"
             d:DesignHeight="640" d:DesignWidth="980"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True">

    <UserControl.Resources>
        <Style x:Key="ResultsChipRadio" TargetType="RadioButton" BasedOn="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}">
            <Setter Property="Margin" Value="0,0,4,0" />
            <Setter Property="Padding" Value="8,2" />
            <Setter Property="MinHeight" Value="28" />
            <Setter Property="FontSize" Value="12" />
        </Style>

        <Style x:Key="ResultsHeaderText" TargetType="TextBlock" BasedOn="{StaticResource LabelMedium}">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style x:Key="ResultsValueText" TargetType="TextBlock" BasedOn="{StaticResource BodySmall}">
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Top Controls -->
        <Border Grid.Row="0"
                Style="{StaticResource Card}"
                Padding="14,10"
                Margin="0,0,0,8"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <DockPanel>
                <!-- Right side: Stats + Action Buttons -->
                <StackPanel DockPanel.Dock="Right" VerticalAlignment="Center" Margin="16,0,0,0">
                    <!-- Stats -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,8">
                        <TextBlock Text="{Binding DuplicateGroups.Count, Mode=OneWay}" Style="{StaticResource Caption}" FontWeight="SemiBold" Opacity="0.6" />
                        <TextBlock Text=" " Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="{DynamicResource Results.Group}" Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="  ·  " Style="{StaticResource Caption}" Opacity="0.4" />
                        <TextBlock Text="{Binding TotalFilesCount, Mode=OneWay}" Style="{StaticResource Caption}" FontWeight="SemiBold" Opacity="0.6" />
                        <TextBlock Text=" " Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="{DynamicResource Results.Files}" Style="{StaticResource Caption}" Opacity="0.6" />
                    </StackPanel>
                    <!-- Buttons -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="{DynamicResource Results.AutoSelect}"
                                Command="{Binding ApplyAutoSelectCommand}"
                                Style="{StaticResource MaterialDesignRaisedButton}"
                                Height="28" Padding="14,0"
                                FontSize="12"
                                Margin="0,0,6,0" />
                        <Button Content="{DynamicResource Results.DeselectAll}"
                                Command="{Binding ClearSelectionCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Height="28" Padding="14,0"
                                FontSize="12" />
                    </StackPanel>
                </StackPanel>

                <!-- Left side: Selection criteria chips -->
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="{DynamicResource Results.Keep}" Style="{StaticResource Caption}" Margin="0,0,0,6" Opacity="0.6" />
                    <StackPanel Orientation="Horizontal">
                        <RadioButton Content="{DynamicResource Results.SizeAsc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectLargest}" Style="{StaticResource ResultsChipRadio}" />
                        <RadioButton Content="{DynamicResource Results.SizeDesc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectSmallest}" Style="{StaticResource ResultsChipRadio}" />
                        <RadioButton Content="{DynamicResource Results.Newest}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectNewest}" Style="{StaticResource ResultsChipRadio}" />
                        <RadioButton Content="{DynamicResource Results.Oldest}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectOldest}" Style="{StaticResource ResultsChipRadio}" />
                        <RadioButton Content="{DynamicResource Results.ResolutionAsc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectHighRes}" Style="{StaticResource ResultsChipRadio}" />
                        <RadioButton Content="{DynamicResource Results.ResolutionDesc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectLowRes}" Style="{StaticResource ResultsChipRadio}" />
                    </StackPanel>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Main content area -->
        <Grid Grid.Row="1"
              Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- File List -->
            <Border Grid.Column="0" Style="{StaticResource Card}" Padding="0" ClipToBounds="True">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Column Headers -->
                    <Border Grid.Row="0"
                            BorderThickness="0,0,0,1"
                            BorderBrush="{StaticResource DividerBrush}"
                            Background="{StaticResource SurfaceBrush}"
                            Padding="16,8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="36" />
                                <ColumnDefinition Width="3*" />
                                <ColumnDefinition Width="1.2*" />
                                <ColumnDefinition Width="1.2*" />
                                <ColumnDefinition Width="1.5*" />
                                <ColumnDefinition Width="1.5*" />
                                <ColumnDefinition Width="1.8*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="1" Text="{DynamicResource Results.ColumnName}" Style="{StaticResource ResultsHeaderText}" />
                            <TextBlock Grid.Column="2" Text="{DynamicResource Results.ColumnSize}" Style="{StaticResource ResultsHeaderText}" />
                            <TextBlock Grid.Column="3" Text="{DynamicResource Results.ColumnResolution}" Style="{StaticResource ResultsHeaderText}" />
                            <TextBlock Grid.Column="4" Text="{DynamicResource Results.ColumnModified}" Style="{StaticResource ResultsHeaderText}" />
                            <TextBlock Grid.Column="5" Text="{DynamicResource Results.ColumnCreated}" Style="{StaticResource ResultsHeaderText}" />
                            <TextBlock Grid.Column="6" Text="{DynamicResource Results.ColumnHash}" Style="{StaticResource ResultsHeaderText}" />
                        </Grid>
                    </Border>

                    <!-- File Rows: flat list, no GroupDescriptions, full virtualization -->
                    <ListView Grid.Row="1"
                              ItemsSource="{Binding DisplayItems}"
                              Background="Transparent"
                              BorderThickness="0"
                              SelectionMode="Single"
                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              VirtualizingPanel.ScrollUnit="Pixel"
                              PreviewMouseLeftButtonUp="FileRow_Click">

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <!-- Group separator: IsFirstInGroup이 true인 행 위에만 표시 -->
                                    <Border Height="2"
                                            Background="{StaticResource BorderBrush}"
                                            Margin="0,3,0,3"
                                            Visibility="{Binding IsFirstInGroup, Converter={StaticResource BoolToVisibilityConverter}}" />

                                    <Grid Height="34">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="36" />
                                            <ColumnDefinition Width="3*" />
                                            <ColumnDefinition Width="1.2*" />
                                            <ColumnDefinition Width="1.2*" />
                                            <ColumnDefinition Width="1.5*" />
                                            <ColumnDefinition Width="1.5*" />
                                            <ColumnDefinition Width="1.8*" />
                                        </Grid.ColumnDefinitions>

                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsSelected}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  IsHitTestVisible="False" />
                                        <TextBlock Grid.Column="1" Text="{Binding FileName}" Style="{StaticResource ResultsValueText}" Margin="0,0,8,0" />
                                        <TextBlock Grid.Column="2" Text="{Binding FormattedSize}" Style="{StaticResource ResultsValueText}" />
                                        <TextBlock Grid.Column="3" Text="{Binding Resolution}" Style="{StaticResource ResultsValueText}" />
                                        <TextBlock Grid.Column="4" Text="{Binding ModifiedDate, StringFormat={}{0:yyyy-MM-dd}}" Style="{StaticResource ResultsValueText}" />
                                        <TextBlock Grid.Column="5" Text="{Binding CreatedDate, StringFormat={}{0:yyyy-MM-dd}}" Style="{StaticResource ResultsValueText}" />
                                        <TextBlock Grid.Column="6" Text="{Binding Hash}" Style="{StaticResource ResultsValueText}" FontFamily="{StaticResource MonospaceFont}" FontSize="11" Opacity="0.7" />
                                    </Grid>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>

                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                <Setter Property="Padding" Value="10,0" />
                                <Setter Property="Margin" Value="0" />
                                <Setter Property="Cursor" Value="Hand" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <Border x:Name="Container"
                                                    Background="{TemplateBinding Background}"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                    <Setter TargetName="Container" Property="Background" Value="#EAF4FF" />
                                                </DataTrigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Container" Property="Background" Value="#F7FAFD" />
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>
                    </ListView>
                </Grid>
            </Border>

            <!-- Detail Panel (only visible when file clicked) -->
            <Border Grid.Column="1" Style="{StaticResource Card}" Padding="14" Width="320" Margin="8,0,0,0"
                    Visibility="{Binding FocusedFile, Converter={StaticResource NullToVisibilityConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,10">
                            <Button DockPanel.Dock="Right"
                                    Style="{StaticResource MaterialDesignIconButton}"
                                    Command="{Binding CloseFocusedFileCommand}"
                                    Width="28" Height="28" Padding="0">
                                <materialDesign:PackIcon Kind="Close" Width="16" Height="16" />
                            </Button>
                            <TextBlock Text="{Binding FocusedFile.FileName}"
                                       Style="{StaticResource TitleSmall}"
                                       TextTrimming="CharacterEllipsis"
                                       Margin="0,3,8,0" />
                        </DockPanel>

                        <Border Background="{StaticResource DividerBrush}" CornerRadius="8" Height="220" Margin="0,0,0,10">
                            <Grid>
                                <materialDesign:PackIcon Kind="FileImage" Width="36" Height="36" HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.25" />
                                <Image Source="{Binding FocusedFile.FilePath, Converter={StaticResource FilePathToThumbnailConverter}, IsAsync=True}"
                                       Stretch="Uniform" Margin="8" />
                            </Grid>
                        </Border>

                        <TextBlock Text="{Binding FocusedFile.FilePath}" Style="{StaticResource Caption}" TextWrapping="Wrap" Margin="0,0,0,10" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Results.Size}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding FocusedFile.FormattedSize}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Results.ResolutionLabel}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FocusedFile.Resolution}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Results.ModifiedDate}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding FocusedFile.ModifiedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="{DynamicResource Results.CreatedDate}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding FocusedFile.CreatedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="{DynamicResource Results.ColumnHash}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding FocusedFile.Hash}" Style="{StaticResource CodeText}" TextWrapping="Wrap" />
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Empty State -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                    Visibility="{Binding HasResults, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}">
            <materialDesign:PackIcon Kind="FileSearch" Width="50" Height="50" HorizontalAlignment="Center" Opacity="0.25" />
            <TextBlock Text="{DynamicResource Results.RunScanHint}" Style="{StaticResource BodyMedium}" HorizontalAlignment="Center" Margin="0,8,0,0" Opacity="0.7" />
        </StackPanel>

        <!-- Bottom Action Bar -->
        <Border Grid.Row="2"
                Style="{StaticResource Card}"
                Padding="14,10"
                Margin="0,8,0,0"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <DockPanel>
                <!-- Right: Action Buttons -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="{DynamicResource Results.Trash}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding MoveToTrashCommand}"
                            Height="32" Padding="16,0"
                            Margin="0,0,8,0" />
                    <Button Content="{DynamicResource Results.Delete}"
                            Style="{StaticResource MaterialDesignRaisedSecondaryButton}"
                            Command="{Binding DeletePermanentlyCommand}"
                            Height="32" Padding="16,0" />
                </StackPanel>

                <!-- Left: Selection Info -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="CheckboxMultipleMarked" Width="18" Height="18" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.6" />
                    <TextBlock Text="{Binding SelectedFilesCount, Mode=OneWay}" Style="{StaticResource BodyMedium}" FontWeight="SemiBold" VerticalAlignment="Center" />
                    <TextBlock Text=" " Style="{StaticResource BodyMedium}" VerticalAlignment="Center" />
                    <TextBlock Text="{DynamicResource Results.SelectedCount}" Style="{StaticResource BodyMedium}" VerticalAlignment="Center" />
                    <TextBlock Text="  ·  " Style="{StaticResource BodyMedium}" VerticalAlignment="Center" Opacity="0.4" />
                    <TextBlock Text="{Binding FormattedPotentialSavings, Mode=OneWay}" Style="{StaticResource BodyMedium}" FontWeight="SemiBold" VerticalAlignment="Center" />
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
