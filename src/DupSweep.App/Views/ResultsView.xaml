<UserControl x:Class="DupSweep.App.Views.ResultsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:DupSweep.App.ViewModels"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance viewmodels:ResultsViewModel}"
             d:DesignHeight="640" d:DesignWidth="980"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True">

    <UserControl.Resources>
        <Style x:Key="ResultsChipRadio" TargetType="RadioButton" BasedOn="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}">
            <Setter Property="Margin" Value="0,0,4,0" />
            <Setter Property="Padding" Value="8,2" />
            <Setter Property="MinHeight" Value="0" />
            <Setter Property="Height" Value="26" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="materialDesign:ButtonAssist.CornerRadius" Value="6" />
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Top Controls -->
        <Border Grid.Row="0"
                Style="{StaticResource Card}"
                Padding="14,10"
                Margin="0,0,0,8"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Row 1: Keep label + Chips -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,10">
                    <TextBlock Text="{DynamicResource Results.Keep}"
                               Style="{StaticResource Caption}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Opacity="0.6"
                               Margin="0,0,10,0" />
                    <RadioButton Content="{DynamicResource Results.SizeAsc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectLargest}" Style="{StaticResource ResultsChipRadio}" />
                    <RadioButton Content="{DynamicResource Results.SizeDesc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectSmallest}" Style="{StaticResource ResultsChipRadio}" />
                    <RadioButton Content="{DynamicResource Results.Newest}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectNewest}" Style="{StaticResource ResultsChipRadio}" />
                    <RadioButton Content="{DynamicResource Results.Oldest}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectOldest}" Style="{StaticResource ResultsChipRadio}" />
                    <RadioButton Content="{DynamicResource Results.ResolutionAsc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectHighRes}" Style="{StaticResource ResultsChipRadio}" />
                    <RadioButton Content="{DynamicResource Results.ResolutionDesc}" GroupName="AutoSelect" IsChecked="{Binding AutoSelectLowRes}" Style="{StaticResource ResultsChipRadio}" />
                </StackPanel>

                <!-- Row 2: Stats left, Buttons right -->
                <DockPanel Grid.Row="1">
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Content="{DynamicResource Results.AutoSelect}"
                                Command="{Binding ApplyAutoSelectCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Foreground="{StaticResource AccentBrush}"
                                BorderBrush="{StaticResource AccentBrush}"
                                Height="28" Padding="14,0"
                                FontSize="12"
                                Margin="0,0,6,0" />
                        <Button Content="{DynamicResource Results.DeselectAll}"
                                Command="{Binding ClearSelectionCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Height="28" Padding="14,0"
                                FontSize="12" />
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{Binding DuplicateGroups.Count, Mode=OneWay}" Style="{StaticResource Caption}" FontWeight="SemiBold" Opacity="0.6" />
                        <TextBlock Text=" " Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="{DynamicResource Results.Group}" Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="  ·  " Style="{StaticResource Caption}" Opacity="0.4" />
                        <TextBlock Text="{Binding TotalFilesCount, Mode=OneWay}" Style="{StaticResource Caption}" FontWeight="SemiBold" Opacity="0.6" />
                        <TextBlock Text=" " Style="{StaticResource Caption}" Opacity="0.6" />
                        <TextBlock Text="{DynamicResource Results.Files}" Style="{StaticResource Caption}" Opacity="0.6" />
                    </StackPanel>
                </DockPanel>
            </Grid>
        </Border>

        <!-- Main content area -->
        <Grid Grid.Row="1"
              Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- File List (DataGrid with native column alignment and resize) -->
            <Border Grid.Column="0" Style="{StaticResource Card}" Padding="0">
                <Grid x:Name="DataGridClip" SizeChanged="DataGridClip_SizeChanged">
                <DataGrid x:Name="FileListView"
                          ItemsSource="{Binding DisplayItems}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CanUserResizeColumns="True"
                          CanUserReorderColumns="False"
                          CanUserSortColumns="False"
                          SelectionMode="Single"
                          SelectionUnit="FullRow"
                          GridLinesVisibility="Vertical"
                          VerticalGridLinesBrush="{StaticResource DividerBrush}"
                          HeadersVisibility="Column"
                          IsReadOnly="True"
                          Background="Transparent"
                          BorderThickness="0"
                          RowHeaderWidth="0"
                          EnableRowVirtualization="True"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          VirtualizingPanel.ScrollUnit="Pixel"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          PreviewMouseLeftButtonUp="FileRow_Click">

                    <!-- Column Header Style -->
                    <DataGrid.ColumnHeaderStyle>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                            <Setter Property="FontWeight" Value="SemiBold" />
                            <Setter Property="FontSize" Value="12" />
                            <Setter Property="FontFamily" Value="{StaticResource PrimaryFont}" />
                            <Setter Property="HorizontalContentAlignment" Value="Left" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="DataGridColumnHeader">
                                        <Grid>
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{StaticResource DividerBrush}"
                                                    BorderThickness="0,0,1,1"
                                                    Padding="8,7">
                                                <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                                  VerticalAlignment="Center"
                                                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                            </Border>
                                            <Thumb x:Name="PART_LeftHeaderGripper"
                                                   HorizontalAlignment="Left"
                                                   Margin="-4,0,0,0"
                                                   Width="8"
                                                   Cursor="SizeWE">
                                                <Thumb.Template>
                                                    <ControlTemplate TargetType="Thumb">
                                                        <Border Background="Transparent" />
                                                    </ControlTemplate>
                                                </Thumb.Template>
                                            </Thumb>
                                            <Thumb x:Name="PART_RightHeaderGripper"
                                                   HorizontalAlignment="Right"
                                                   Margin="0,0,-4,0"
                                                   Width="8"
                                                   Cursor="SizeWE">
                                                <Thumb.Template>
                                                    <ControlTemplate TargetType="Thumb">
                                                        <Border Background="Transparent" />
                                                    </ControlTemplate>
                                                </Thumb.Template>
                                            </Thumb>
                                        </Grid>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.ColumnHeaderStyle>

                    <!-- Cell Style: suppress default selection visuals -->
                    <DataGrid.CellStyle>
                        <Style TargetType="DataGridCell">
                            <Setter Property="Focusable" Value="False" />
                            <Setter Property="FontFamily" Value="{StaticResource PrimaryFont}" />
                            <Setter Property="FontSize" Value="12" />
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="DataGridCell">
                                        <Border Background="Transparent" Padding="8,4">
                                            <ContentPresenter VerticalAlignment="Center" />
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.CellStyle>

                    <!-- Row Style: custom selection + group separator -->
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="Cursor" Value="Hand" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="DataGridRow">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="*" />
                                            </Grid.RowDefinitions>
                                            <Border x:Name="GroupSeparator"
                                                    Grid.Row="0"
                                                    Height="2"
                                                    Background="{StaticResource BorderBrush}"
                                                    Visibility="Collapsed" />
                                            <Border x:Name="RowBorder"
                                                    Grid.Row="1"
                                                    Background="Transparent"
                                                    BorderBrush="{StaticResource DividerBrush}"
                                                    BorderThickness="0,0,0,1"
                                                    SnapsToDevicePixels="True">
                                                <DataGridCellsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                            </Border>
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <DataTrigger Binding="{Binding IsFirstInGroup}" Value="True">
                                                <Setter TargetName="GroupSeparator" Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                <Setter TargetName="RowBorder" Property="Background" Value="#EAF4FF" />
                                            </DataTrigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="RowBorder" Property="Background" Value="#F7FAFD" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.RowStyle>

                    <!-- Columns -->
                    <DataGrid.Columns>
                        <!-- Checkbox -->
                        <DataGridTemplateColumn Width="46" CanUserResize="False" CanUserSort="False">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsSelected, Mode=OneWay}"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              IsHitTestVisible="False" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- File Name -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnName}"
                                            Binding="{Binding FileName, Mode=OneWay}"
                                            Width="160">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Directory Path (fills remaining space) -->
                        <DataGridTextColumn Header="{DynamicResource Results.Path}"
                                            Binding="{Binding DirectoryPath, Mode=OneWay}"
                                            Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                    <Setter Property="ToolTip" Value="{Binding FilePath}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Size -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnSize}"
                                            Binding="{Binding FormattedSize, Mode=OneWay}"
                                            Width="75">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Resolution -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnResolution}"
                                            Binding="{Binding Resolution, Mode=OneWay}"
                                            Width="75">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Modified Date -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnModified}"
                                            Binding="{Binding ModifiedDate, Mode=OneWay, StringFormat={}{0:yyyy-MM-dd}}"
                                            Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Created Date -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnCreated}"
                                            Binding="{Binding CreatedDate, Mode=OneWay, StringFormat={}{0:yyyy-MM-dd}}"
                                            Width="90">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Hash (conditionally shown via code-behind) -->
                        <DataGridTextColumn Header="{DynamicResource Results.ColumnHash}"
                                            Binding="{Binding Hash, Mode=OneWay}"
                                            Width="130"
                                            Visibility="Collapsed">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="{StaticResource MonospaceFont}" />
                                    <Setter Property="FontSize" Value="11" />
                                    <Setter Property="Opacity" Value="0.7" />
                                    <Setter Property="TextTrimming" Value="CharacterEllipsis" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
                </Grid>
            </Border>

            <!-- Detail Panel (only visible when file clicked) -->
            <Border Grid.Column="1" Style="{StaticResource Card}" Padding="14" Width="320" Margin="8,0,0,0"
                    Visibility="{Binding FocusedFile, Converter={StaticResource NullToVisibilityConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <DockPanel Margin="0,0,0,10">
                            <Button DockPanel.Dock="Right"
                                    Style="{StaticResource MaterialDesignIconButton}"
                                    Command="{Binding CloseFocusedFileCommand}"
                                    Width="28" Height="28" Padding="0">
                                <materialDesign:PackIcon Kind="Close" Width="16" Height="16" />
                            </Button>
                            <TextBlock Text="{Binding FocusedFile.FileName}"
                                       Style="{StaticResource TitleSmall}"
                                       TextTrimming="CharacterEllipsis"
                                       Margin="0,3,8,0" />
                        </DockPanel>

                        <Border Background="{StaticResource DividerBrush}" CornerRadius="8" Height="220" Margin="0,0,0,10">
                            <Grid>
                                <materialDesign:PackIcon Kind="FileImage" Width="36" Height="36" HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.25" />
                                <Image Source="{Binding FocusedFile.FilePath, Converter={StaticResource FilePathToThumbnailConverter}, IsAsync=True}"
                                       Stretch="Uniform" Margin="8" />
                            </Grid>
                        </Border>

                        <TextBlock Text="{Binding FocusedFile.FilePath}" Style="{StaticResource Caption}" TextWrapping="Wrap" Margin="0,0,0,10" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Results.Size}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding FocusedFile.FormattedSize}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Results.ResolutionLabel}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding FocusedFile.Resolution}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Results.ModifiedDate}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding FocusedFile.ModifiedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="{DynamicResource Results.CreatedDate}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding FocusedFile.CreatedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Style="{StaticResource BodySmall}" />

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="{DynamicResource Results.ColumnHash}" Style="{StaticResource LabelMedium}" Margin="0,0,10,6" />
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding FocusedFile.Hash}" Style="{StaticResource CodeText}" TextWrapping="Wrap" />
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Empty State -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                    Visibility="{Binding HasResults, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}">
            <materialDesign:PackIcon Kind="FileSearch" Width="50" Height="50" HorizontalAlignment="Center" Opacity="0.25" />
            <TextBlock Text="{DynamicResource Results.RunScanHint}" Style="{StaticResource BodyMedium}" HorizontalAlignment="Center" Margin="0,8,0,0" Opacity="0.7" />
        </StackPanel>

        <!-- Bottom Action Bar -->
        <Border Grid.Row="2"
                Style="{StaticResource Card}"
                Padding="14,10"
                Margin="0,8,0,0"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <DockPanel>
                <!-- Right: Action Buttons -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="{DynamicResource Results.Trash}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding MoveToTrashCommand}"
                            Height="32" Padding="16,0"
                            Margin="0,0,8,0" />
                    <Button Content="{DynamicResource Results.Delete}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Background="#E53935"
                            Foreground="White"
                            BorderBrush="#E53935"
                            materialDesign:ButtonAssist.CornerRadius="4"
                            Command="{Binding DeletePermanentlyCommand}"
                            Height="32" Padding="16,0" />
                </StackPanel>

                <!-- Left: Selection Info -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="CheckboxMultipleMarked" Width="18" Height="18" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.6" />
                    <TextBlock Text="{Binding SelectedFilesCount, Mode=OneWay}" Style="{StaticResource BodyMedium}" FontWeight="SemiBold" VerticalAlignment="Center" />
                    <TextBlock Text=" " Style="{StaticResource BodyMedium}" VerticalAlignment="Center" />
                    <TextBlock Text="{DynamicResource Results.SelectedCount}" Style="{StaticResource BodyMedium}" VerticalAlignment="Center" />
                    <TextBlock Text="  ·  " Style="{StaticResource BodyMedium}" VerticalAlignment="Center" Opacity="0.4" />
                    <TextBlock Text="{Binding FormattedPotentialSavings, Mode=OneWay}" Style="{StaticResource BodyMedium}" FontWeight="SemiBold" VerticalAlignment="Center" />
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
