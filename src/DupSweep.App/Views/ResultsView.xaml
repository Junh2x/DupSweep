<UserControl x:Class="DupSweep.App.Views.ResultsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:DupSweep.App.ViewModels"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance viewmodels:ResultsViewModel}"
             d:DesignHeight="600" d:DesignWidth="900">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Auto Select Bar -->
        <Border Grid.Row="0"
                Background="{DynamicResource MaterialDesignToolBarBackground}"
                Padding="8"
                Margin="0,0,0,8"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <DockPanel>
                <!-- 우측: 통계 및 선택해제 버튼 -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock VerticalAlignment="Center" Margin="0,0,12,0" FontSize="11" Opacity="0.6">
                        <Run Text="{Binding DuplicateGroups.Count, Mode=OneWay}" />
                        <Run Text="그룹 /" />
                        <Run Text="{Binding TotalFilesCount, Mode=OneWay}" />
                        <Run Text="파일" />
                    </TextBlock>
                    <Button Content="선택 해제"
                            Command="{Binding ClearSelectionCommand}"
                            Style="{StaticResource MaterialDesignOutlinedButton}"
                            Padding="12,4" Height="28" />
                </StackPanel>

                <!-- 좌측: 자동선택 옵션 및 버튼 -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="유지:" FontSize="12" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.7" />
                    <RadioButton Content="용량↑" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectLargest}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,4,0" Padding="8,4" />
                    <RadioButton Content="용량↓" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectSmallest}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,4,0" Padding="8,4" />
                    <RadioButton Content="최신" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectNewest}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,4,0" Padding="8,4" />
                    <RadioButton Content="오래된" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectOldest}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,4,0" Padding="8,4" />
                    <RadioButton Content="해상도↑" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectHighRes}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,4,0" Padding="8,4" />
                    <RadioButton Content="해상도↓" GroupName="AutoSelect"
                                 IsChecked="{Binding AutoSelectLowRes}"
                                 Style="{StaticResource MaterialDesignChoiceChipOutlineRadioButton}"
                                 Margin="0,0,8,0" Padding="8,4" />
                    <Button Content="자동 선택"
                            Command="{Binding ApplyAutoSelectCommand}"
                            Style="{StaticResource MaterialDesignRaisedButton}"
                            Padding="12,4" Height="28" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Results List -->
        <ListBox Grid.Row="1"
                 ItemsSource="{Binding DuplicateGroupsView}"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                 Background="Transparent"
                 BorderThickness="0"
                 ScrollViewer.CanContentScroll="False">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0,0,0,6" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Border Background="{DynamicResource MaterialDesignCardBackground}" Padding="8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Group Header -->
                            <DockPanel Grid.Row="0" Margin="0,0,0,4">
                                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                                    <TextBlock Text="{Binding Similarity, StringFormat={}{0:0}%}"
                                               FontSize="11" Margin="0,0,8,0"
                                               Foreground="{DynamicResource PrimaryHueMidBrush}" />
                                    <TextBlock Text="{Binding GroupType}" FontSize="11" Opacity="0.5" />
                                </StackPanel>
                                <TextBlock FontSize="12" FontWeight="Medium">
                                    <Run Text="{Binding FileCount, Mode=OneWay}" />
                                    <Run Text="개 파일" />
                                </TextBlock>
                            </DockPanel>

                            <!-- File Cards -->
                            <ItemsControl Grid.Row="1" ItemsSource="{Binding Files}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="220" Margin="0,0,4,4"
                                                CornerRadius="4" Cursor="Hand"
                                                BorderThickness="2"
                                                MouseLeftButtonDown="FileCard_Click"
                                                ToolTipService.InitialShowDelay="200">
                                            <Border.ToolTip>
                                                <StackPanel MaxWidth="400">
                                                    <TextBlock Text="{Binding FilePath}" TextWrapping="Wrap" FontWeight="Medium" />
                                                    <Separator Margin="0,4" />
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="*" />
                                                        </Grid.ColumnDefinitions>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition />
                                                            <RowDefinition />
                                                            <RowDefinition />
                                                            <RowDefinition />
                                                        </Grid.RowDefinitions>
                                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="크기: " Opacity="0.7" />
                                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding FormattedSize}" />
                                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="해상도: " Opacity="0.7" />
                                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Resolution}" />
                                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="수정일: " Opacity="0.7" />
                                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ModifiedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" />
                                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="생성일: " Opacity="0.7" />
                                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding CreatedDate, StringFormat={}{0:yyyy-MM-dd HH:mm}}" />
                                                    </Grid>
                                                </StackPanel>
                                            </Border.ToolTip>
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="{DynamicResource MaterialDesignToolBarBackground}" />
                                                    <Setter Property="BorderBrush" Value="Transparent" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                            <Setter Property="BorderBrush" Value="#2196F3" />
                                                            <Setter Property="Background" Value="#E3F2FD" />
                                                        </DataTrigger>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="BorderBrush" Value="{DynamicResource MaterialDesignDivider}" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>

                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="60" />
                                                    <ColumnDefinition Width="*" />
                                                </Grid.ColumnDefinitions>

                                                <!-- Thumbnail -->
                                                <Border Grid.Column="0" Background="{DynamicResource MaterialDesignDivider}"
                                                        CornerRadius="4,0,0,4" Height="60">
                                                    <Grid>
                                                        <materialDesign:PackIcon Kind="FileImage" Width="24" Height="24"
                                                                                  HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                                  Opacity="0.3" />
                                                        <Image Source="{Binding FilePath, Converter={StaticResource FilePathToThumbnailConverter}, IsAsync=True}"
                                                               Stretch="UniformToFill" />
                                                    </Grid>
                                                </Border>

                                                <!-- File Info -->
                                                <StackPanel Grid.Column="1" Margin="6,4" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding FileName}" FontSize="11" FontWeight="Medium"
                                                               TextTrimming="CharacterEllipsis" />
                                                    <TextBlock FontSize="10" Opacity="0.7" Margin="0,2,0,0">
                                                        <Run Text="{Binding FormattedSize, Mode=OneWay}" />
                                                    </TextBlock>
                                                    <TextBlock FontSize="10" Opacity="0.5">
                                                        <Run Text="{Binding Resolution, Mode=OneWay}" />
                                                    </TextBlock>
                                                    <TextBlock FontSize="9" Opacity="0.4">
                                                        <Run Text="{Binding ModifiedDate, StringFormat={}{0:yy-MM-dd}, Mode=OneWay}" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- No Results -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                    Visibility="{Binding HasResults, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}">
            <materialDesign:PackIcon Kind="FileSearch" Width="48" Height="48"
                                     HorizontalAlignment="Center" Opacity="0.3" />
            <TextBlock Text="스캔을 실행하여 중복 파일을 찾으세요" FontSize="12"
                       HorizontalAlignment="Center" Margin="0,8,0,0" Opacity="0.5" />
        </StackPanel>

        <!-- Action Bar -->
        <Border Grid.Row="2" Background="{DynamicResource MaterialDesignCardBackground}"
                Margin="0,8,0,0" Padding="8"
                Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
            <DockPanel>
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <materialDesign:PackIcon Kind="Delete" Width="16" Height="16"
                                              VerticalAlignment="Center" Margin="0,0,4,0" Opacity="0.6" />
                    <TextBlock VerticalAlignment="Center" FontSize="12">
                        <Run Text="{Binding SelectedFilesCount, Mode=OneWay}" FontWeight="Bold" />
                        <Run Text="개 선택" />
                    </TextBlock>
                    <TextBlock VerticalAlignment="Center" FontSize="12"
                               Foreground="{DynamicResource SecondaryHueMidBrush}" Margin="8,0,0,0">
                        <Run Text="(" /><Run Text="{Binding FormattedPotentialSavings, Mode=OneWay}" /><Run Text=")" />
                    </TextBlock>
                </StackPanel>

                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                    <Button Content="휴지통" Style="{StaticResource MaterialDesignOutlinedButton}"
                            Command="{Binding MoveToTrashCommand}" Margin="0,0,4,0"
                            Padding="12,4" Height="28" />
                    <Button Content="삭제" Style="{StaticResource MaterialDesignRaisedSecondaryButton}"
                            Command="{Binding DeletePermanentlyCommand}"
                            Padding="12,4" Height="28" />
                </StackPanel>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
